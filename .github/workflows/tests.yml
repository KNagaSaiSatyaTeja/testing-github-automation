name: testing github action
on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install pytest
        run: |
          pip install pytest

      - name: Check/Create Testcases File Using Python
        run: |
          mkdir -p .tests
          if [ ! -f ".tests/testcases.py" ]; then
            echo "Creating testcases.py in .tests/ directory..."
            cat <<EOF > .tests/testcases.py
          import main

          def test_add():
              assert main.add(2, 3) == 5
              assert main.add(-1, 1) == 0
              assert main.add(0, 0) == 0

          if __name__ == "__main__":
              print("‚úÖ All test cases passed!")
          EOF
            echo "‚úÖ testcases.py created successfully."
          else
            echo "‚úÖ testcases.py already exists in .tests/ directory."
          fi

      - name: List Files After Creation
        run: ls -R .github/workflows

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add and Commit Changes
        run: |
          git add .tests/testcases.py
          git commit -m "üöÄ Auto-generate testcases.py for main.py" || echo "No changes to commit"
          git push https://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:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git

      - name: Run Tests and Show Summary
        run: |
          if [ -f ".tests/testcases.py" ]; then
            # Run pytest and capture results in a variable
            result=$(pytest .tests/testcases.py --tb=short -q || true)
            
            # Get the number of passed test cases
            passed=$(echo "$result" | grep -oP '\d+ passed' | awk '{print $1}')
            
            # Get the total number of test cases (passed + failed)
            total=$(echo "$result" | grep -oP '\d+ passed|\d+ failed' | awk '{sum+=$1} END {print sum}')

            # Show summary
            echo "‚úÖ Tests Passed: ${passed:-0} / ${total:-0}"

            # Fail if any tests failed
            if [ "${passed:-0}" -lt "${total:-0}" ]; then
              exit 1
            fi
          else
            echo "‚ö†Ô∏è No testcases.py found. Skipping tests."
          fi

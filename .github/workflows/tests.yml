name: testing github action
on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install pytest
        run: |
          pip install pytest

      - name: Check/Create Testcases File Using Python
        run: |
          python3 - <<EOF
          import os
          import ast


          main_file_path = "main.py"
          file_path = ".github/workflows/testcases.py"

          if os.path.isfile(main_file_path):
            print("âœ… main.py found. Checking test file exists...")

          print(f"ðŸ“‚ Current directory: {os.getcwd()}")
          print(f"ðŸ”Ž Absolute path of testcases.py: {os.path.abspath(file_path)}")
          print(f"ðŸ”Ž Checking if main.py exists...")
          print(f"âœ… main.py found: {os.path.isfile(main_file_path)}")
          if os.path.isfile(file_path):
            print("âœ… testcases.py already exists in workflows.")
          else:
              print("âŒ testcases.py NOT found. Creating it now...")
              os.makedirs(".github/workflows", exist_ok=True)
              
              # Create the testcases.py file with sample pytest test cases
              with open(file_path, "w") as f:
                  f.write("import pytest\\n\\n")
                  f.write("count=0")
                  f.write("def test_add(a=1,b=2, expected=3):\\n")
                  f.write("    assert add(a, b) == expected\\n")
              print("âœ…  ")
          EOF

      - name: List Files After Creation
        run: ls -R .github/workflows

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add and Commit Changes
        run: |
          git add .github/workflows/testcases.py
          git commit -m "ðŸš€ Auto-generate testcases.py for main.py" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git

      - name: Run Tests and Show Summary
        run: |
          if [ -f "testcases.py" ]; then
            # Run pytest and capture results in a variable
            result=$(pytest testcases.py --tb=short -q)
            
            # Get the number of passed test cases
            passed=$(echo "$result" | grep -oP '\d+ passed' | awk '{print $1}')
            
            # Get the total number of test cases (passed + failed)
            total=$(echo "$result" | grep -oP '\d+ passed|\d+ failed' | awk '{sum+=$1} END {print sum}')

            # Show summary
            echo "âœ… Tests Passed: ${passed:-0} / ${total:-0}"

            # Fail if any tests failed
            if [ "${passed:-0}" -lt "${total:-0}" ]; then
              exit 1
            fi
          else
            echo "âš ï¸ No testcases.py found. Skipping tests."
          fi
